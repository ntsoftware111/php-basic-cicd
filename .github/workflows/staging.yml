name: Tự động merge và đẩy lên Staging

on:
  pull_request:
    branches:
      - develop
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-deploy-pipeline:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout mã nguồn
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Quan trọng để có lịch sử commit khi merge

      # 2. Setup môi trường & Check Syntax
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
          coverage: none

      - name: Check PHP Syntax
        run: find . -name "*.php" -print0 | xargs -0 -n1 php -l

      # 3. Merge PR hiện tại vào develop
      - name: Merge PR to develop
        id: merge_dev
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          echo "Merging PR to develop..."
          gh pr merge --merge "$PR_URL"
          # Cập nhật code local sau khi merge để có code mới nhất cho bước sau
          git pull origin develop

      # 4. Xử lý đẩy lên Staging (Ngay lập tức sau khi dev merge thành công)
      - name: Create and Merge PR to staging
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for changes between develop and staging..."
          
          # Tạo PR từ develop sang staging
          # Dùng || true để tránh lỗi nếu PR đã tồn tại
          PR_STAGING_URL=$(gh pr create \
            --base staging \
            --head develop \
            --title "Auto-merge: develop to staging (via PR #${{ github.event.pull_request.number }})" \
            --body "Tự động chuyển mã nguồn từ develop sang staging sau khi PR #${{ github.event.pull_request.number }} được merge." || \
            gh pr list --base staging --head develop --state open --json url --jq '.[0].url')

          if [ -n "$PR_STAGING_URL" ]; then
            echo "Merging PR to staging: $PR_STAGING_URL"
            gh pr merge --merge "$PR_STAGING_URL"
          else
            echo "No changes to merge to staging or PR already handled."
          fi