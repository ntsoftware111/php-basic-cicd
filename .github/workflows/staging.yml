name: Tá»± Ä‘á»™ng merge vÃ  Ä‘áº©y lÃªn Staging

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

permissions:
  contents: write
  pull-requests: write

jobs:
  build-develop:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
          coverage: none    
      
      - name: Check PHP Syntax
        run: find . -name "*.php" -print0 | xargs -0 -n1 php -l

      # Tá»± Ä‘á»™ng Merge PR vÃ o develop (náº¿u workflow nÃ y kÃ­ch hoáº¡t bá»Ÿi PR vÃ o develop)
      - name: Merge PR to develop
        if: github.event_name == 'pull_request'
        run: gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # JOB Má»šI: Tá»± Ä‘á»™ng Ä‘Æ°a code tá»« develop lÃªn staging
  create-and-merge-to-staging:
    needs: build-develop
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create PR to staging
        id: create_pr
        run: |
          pr_url=$(gh pr create \
            --base staging \
            --head develop \
            --title "ðŸš€ Auto-merge: develop to staging" \
            --body "Tá»± Ä‘á»™ng chuyá»ƒn mÃ£ nguá»“n tá»« develop sang staging sau khi kiá»ƒm tra cÃº phÃ¡p thÃ nh cÃ´ng.")
          echo "PR_URL=$pr_url" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge PR to staging
        if: steps.create_pr.outputs.PR_URL != ''
        run: gh pr merge --merge "${{ steps.create_pr.outputs.PR_URL }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}